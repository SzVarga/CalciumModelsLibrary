---
title: "Calcium Model Library - User Information"
author: "Nicolas Huber"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Calcium Model Library - User Information}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

```{r setup}
library(CalciumModelsLibrary)
```

## Introduction

This R package contains mathematical models of proteins which are differentially regulated by calcium. 
All implemented models can be simulated stochastically and deterministically via an intuitive interface which allows the user to define both simulation and model-specific parameters as well as the visualization of the simulation output. 

## Simulation

Stochastic model files are implemented in C++ and are accessed by R via functions provided by the [Rcpp package](https://cran.r-project.org/web/packages/Rcpp/index.html). The stochastic simulation is handled by a custom implementation of Gillespie's Direct Method (Gillespie, 1977). Therefore, stochastic model files provide propensity equations for all reactions.

Deterministic model files are implemented in R and contain sets of differential equations. They are simulated by the LSODA algorithm (Hindmarsh, 1983) as it is implemented in the [deSolve package](https://cran.r-project.org/web/packages/deSolve/index.html).


## Model Information

The following table lists all models that are part of this library. The model keys are internally used as model names and specify the simulation functions: stochastic simulation functions are named "sim_[MODEL_KEY]", deterministic simulation functions "[MODEL_KEY]_detSim" 

+---------------+---------------+
| Model Key     | References    |
+===============+===============+
| ano           | Jonas Förster\   |
|               | .....................................................................................................................     |
+---------------+---------------+
| calcineurin   | Fisher, W. G., Yang, P.-C., Medikonduri, R. K., and Jafri, M. S. (2006). **NFAT and NFkB Activation in T Lymphocytes: A Model of Diﬀerential Activation of Gene Expression**. Annals of Biomedical Engineering 34, 1712–1728.\   |
+---------------+---------------+
| calmodulin    | Dr. Jürgen Pahle\   |
|               | ......................................................................................................................     |
+---------------+---------------+
| camkii        | Sarah Kaspar\   |
|               | .....................................................................................................................     |
+---------------+---------------+
| glycphos      | Gall, D., Baus, E., and Dupont, G. (2000). **Activation of the liver glycogen phosphorylase by Ca(2+)oscillations: a theoretical study**. Journal of Theoretical Biology 207, 445–454.\   |
+---------------+---------------+
| pkc           | Manninen, T., Linne, M.L., and Ruohonen, K. (2006). **Developing Ito stochastic differential equation models for neuronal signal transduction pathways**. Comput Biol Chem 30(4), 280-291.\   |
|               | Intosalmi, J., Manninen, T., Ruohonen, K., and Linne, M. L. (2009). **Modeling protein kinase C activation in the presence of calcium ion fluctuations**. At the Sixth International Workshop on Computational Systems Biology, WCSB 2009, June 10-12, in Aarhus, Denmark. p. 75-78.\     |
|               | Bhalla, U.S. and R. Iyengar. (1999). **Emergent properties of networks of biological signaling pathways**. Science 283(5400), 381-387.     |
+---------------+---------------+

Add more information! (cite publications, add info on relevant changes, etc.)

## Use Cases

### 1. Stochastic Simulation of the Calmodulin Model

```{r fig1, fig.height = 5, fig.width = 7, fig.align = "center"}
# Supply simulation parameters as vector
sim_params <- c(timestep = 0.05,
                endTime = 100)
# Supply model parameters as list
model_params <- list(vol = 5e-14,
                     init_conc = c(Prot_inact = 5,
                                   Prot_act = 0))

# Supply a calcium input timeseries file
input_df <- read.table(system.file("extdata/ca5e-14_2.85_1000_0.05s.out", package = "CalciumModelsLibrary"), col.names = c("time", "steps", "G_alpha", "PLC", "Ca"))
f <- 6.0221415e14*model_params[["vol"]]
input_df["Ca"] <- input_df["Ca"]/f

# Stochastically simulate the model
output <- sim_calmodulin(input_df, sim_params, model_params)
output <- as.data.frame(output)

# Plot the output
colnames(output) <- c("time", "calcium", "Prot_inact", "Prot_act")
plot(output$time, output$calcium, col="blue", xlim=c(0, 100), ylim=c(0,15), type="l", xlab="time", ylab="concentration")
lines(output$time, output$Prot_act, col="red", type="l")
legend("topright", legend=c("calcium", "Prot_act"), col=c("blue", "red"), lty=c(1,1))
```

**Detailed Description**

It is mandatory to provide all simulation parameters (timestep and end time), some initial conditions as well as a volume of the model since these parameters have no associated default values in the source code.
Model parameters (reaction rate constants, affinities, etc.) on the other hand can be supplied if the user whishes to overwrite the model specific default values which are defined in the model files.  

Since all implemented models are dependent on calcium as regulator it is necessary to provide a calcium time series as input which can either be a smooth function or a discrete set of (experimentally measured) points. 
In this specific example the number of calcium particles at discrete time points is supplied as a table. Since all simulation functions expect calcium concentration values as input the respective column is divided by the factor $f = volume*N_A$ where $N_A$ is the Avogadro constant.

Folowing the naming convention described above (section Model Information) the stochastic simulation of the calmodulin model is executed by calling "sim_calmodulin". Afterwards, the simulation output needs to be converted to a data frame object before it can be plotted in typical R fashion.


## Code Structure

There is a fundamental difference in the implementation of stochstic model files compared to deterministic model files. 

**Stochastic Model Files**

All stochastic model files are written in C++ and contain two blocks: the R export options and the model description. 

The R export options consist of macros which define the model name and include the stochastic simulation function. Additionally a function is defined which checks user supplied parameters and runs the simulation. This wrapper function is named sim_*[MODEL_KEY]* for all models and is exported to R via Rcpp.

The model description includes three functions which define model specific properties: 

- *init*: defines and returns an array of default values for all model parameters 
- *calculate_amu*: contains all propensity equations and saves the cumulative propensities in a vector 
- *update_system*: given a reaction index (rIndex) updates the system state by instantiating the chosen reaction according to the stoichiometry

**Deterministic Model Files**

The deterministic model files are written in R exclusively and contain a function which is named *[MODEL_KEY]*_detSim for all models. 
This function describes the model by defining the set of differential equations, prepares the calcium input by converting it to events and runs the simulation by calling the lsoda function of the deSolve package. 
